# Documentação RF04, RF05 e RF06

## RF04 - Gerenciamento de Voluntários

### Descrição
Sistema completo de CRUD para gerenciamento de voluntários com validações de CPF, email e armazenamento de habilidades.

### Endpoints

#### POST /volunteers
Cria um novo voluntário.

**Request Body:**
```json
{
  "nome": "João Silva",
  "cpf": "12345678901",
  "email": "joao@example.com",
  "telefone": "11999999999",
  "habilidades": "Cuidados com animais, Treinamento",
  "preferencias_atuacao": "Manhã, Fim de semana"
}
```

**Validações:**
- CPF deve ter exatamente 11 dígitos numéricos
- CPF deve ser único no sistema
- Email deve ser válido
- Email deve ser único no sistema
- Nome e telefone são obrigatórios

**Response (201):**
```json
{
  "id_voluntario": 1,
  "nome": "João Silva",
  "cpf": "12345678901",
  "email": "joao@example.com",
  "telefone": "11999999999",
  "habilidades": "Cuidados com animais, Treinamento",
  "preferencias_atuacao": "Manhã, Fim de semana"
}
```

**Erros:**
- 409 Conflict: CPF ou email já cadastrado
- 400 Bad Request: Validação falhou

#### GET /volunteers
Lista todos os voluntários cadastrados.

**Response (200):**
```json
[
  {
    "id_voluntario": 1,
    "nome": "João Silva",
    "cpf": "12345678901",
    "email": "joao@example.com",
    "telefone": "11999999999",
    "habilidades": "Cuidados com animais",
    "preferencias_atuacao": "Manhã",
    "preferencia": [...]
  }
]
```

#### GET /volunteers/:id
Busca um voluntário específico por ID.

**Response (200):**
```json
{
  "id_voluntario": 1,
  "nome": "João Silva",
  "cpf": "12345678901",
  "email": "joao@example.com",
  "telefone": "11999999999",
  "habilidades": "Cuidados com animais",
  "preferencias_atuacao": "Manhã",
  "preferencia": [...]
}
```

**Erros:**
- 404 Not Found: Voluntário não encontrado

#### PUT /volunteers/:id
Atualiza dados de um voluntário.

**Request Body (todos os campos são opcionais):**
```json
{
  "nome": "João Silva Atualizado",
  "telefone": "11888888888"
}
```

**Response (200):**
```json
{
  "id_voluntario": 1,
  "nome": "João Silva Atualizado",
  "cpf": "12345678901",
  "email": "joao@example.com",
  "telefone": "11888888888",
  ...
}
```

**Erros:**
- 404 Not Found: Voluntário não encontrado
- 409 Conflict: CPF ou email já cadastrado (se estiver tentando atualizar para um valor já existente)

#### DELETE /volunteers/:id
Remove um voluntário do sistema.

**Response (200):**
```json
{
  "id_voluntario": 1,
  "nome": "João Silva",
  ...
}
```

**Erros:**
- 404 Not Found: Voluntário não encontrado

#### GET /volunteers/:id/tasks
Lista todas as tarefas atribuídas a um voluntário.

**Response (200):**
```json
[
  {
    "id_tarefa": 1,
    "title": "Vacinar cachorro",
    "descricao": "Aplicar vacina antirrábica",
    "id_voluntario": 1,
    "status_tarefa": {
      "id_status": 2,
      "status": "assigned"
    },
    ...
  }
]
```

**Erros:**
- 404 Not Found: Voluntário não encontrado

---

## RF05 - Preferências de Atuação

### Descrição
Sistema para gerenciar preferências específicas de cada voluntário, como áreas de atuação, horários disponíveis, etc.

### Endpoints

#### POST /volunteers/:id/preferences
Cria uma nova preferência para um voluntário.

**Request Body:**
```json
{
  "tipo": "area",
  "valor": "cuidados veterinários"
}
```

**Response (201):**
```json
{
  "id_preferencia": 1,
  "id_voluntario": 1,
  "tipo": "area",
  "valor": "cuidados veterinários",
  "created_at": "2025-01-05T10:30:00.000Z"
}
```

**Erros:**
- 404 Not Found: Voluntário não encontrado
- 400 Bad Request: Validação falhou

#### GET /volunteers/:id/preferences
Lista todas as preferências de um voluntário.

**Response (200):**
```json
[
  {
    "id_preferencia": 1,
    "id_voluntario": 1,
    "tipo": "area",
    "valor": "cuidados veterinários",
    "created_at": "2025-01-05T10:30:00.000Z"
  },
  {
    "id_preferencia": 2,
    "id_voluntario": 1,
    "tipo": "horario",
    "valor": "manhã",
    "created_at": "2025-01-05T10:35:00.000Z"
  }
]
```

**Erros:**
- 404 Not Found: Voluntário não encontrado

#### DELETE /volunteers/:id/preferences/:prefId
Remove uma preferência específica.

**Response (200):**
```json
{
  "id_preferencia": 1,
  "id_voluntario": 1,
  "tipo": "area",
  "valor": "cuidados veterinários",
  "created_at": "2025-01-05T10:30:00.000Z"
}
```

**Erros:**
- 404 Not Found: Preferência não encontrada ou não pertence ao voluntário

---

## RF06 - Sistema de Tarefas

### Descrição
Sistema completo de gerenciamento de tarefas com controle de estados (pending, assigned, completed), atribuição a voluntários e filtros de listagem.

### Endpoints

#### POST /tasks
Cria uma nova tarefa.

**Request Body:**
```json
{
  "title": "Vacinar cachorro",
  "descricao": "Aplicar vacina antirrábica no cachorro Rex",
  "target_entity": "animal",
  "due_date": "2025-02-01",
  "id_animal": 5
}
```

**Campos:**
- `title`: Título da tarefa (obrigatório)
- `descricao`: Descrição detalhada (obrigatório)
- `target_entity`: Entidade alvo da tarefa (opcional)
- `due_date`: Data de vencimento (opcional, formato ISO)
- `id_animal`: ID do animal relacionado (opcional)

**Response (201):**
```json
{
  "id_tarefa": 1,
  "title": "Vacinar cachorro",
  "descricao": "Aplicar vacina antirrábica no cachorro Rex",
  "target_entity": "animal",
  "due_date": "2025-02-01T00:00:00.000Z",
  "data": "2025-01-05T00:00:00.000Z",
  "id_status": 1,
  "id_voluntario": null,
  "id_animal": 5,
  "created_at": "2025-01-05T10:30:00.000Z",
  "updated_at": "2025-01-05T10:30:00.000Z",
  "status_tarefa": {
    "id_status": 1,
    "status": "pending"
  },
  "animal": {...}
}
```

**Nota:** Tarefas são criadas automaticamente com status "pending".

#### GET /tasks
Lista todas as tarefas com filtros opcionais.

**Query Parameters:**
- `status`: Filtra por status (pending, assigned, completed)
- `assigned_to`: Filtra por ID do voluntário atribuído

**Exemplos:**
- `GET /tasks` - Lista todas as tarefas
- `GET /tasks?status=pending` - Lista apenas tarefas pendentes
- `GET /tasks?assigned_to=5` - Lista tarefas atribuídas ao voluntário ID 5
- `GET /tasks?status=assigned&assigned_to=5` - Lista tarefas atribuídas ao voluntário ID 5 com status assigned

**Response (200):**
```json
[
  {
    "id_tarefa": 1,
    "title": "Vacinar cachorro",
    "descricao": "Aplicar vacina antirrábica",
    "status_tarefa": {
      "id_status": 1,
      "status": "pending"
    },
    "voluntario": null,
    "animal": {...}
  }
]
```

#### POST /tasks/:id/assign
Atribui uma tarefa a um voluntário.

**Request Body:**
```json
{
  "id_voluntario": 5
}
```

**Validações:**
- Tarefa deve existir
- Voluntário deve existir
- Tarefa deve estar com status "pending"

**Response (201):**
```json
{
  "id_tarefa": 1,
  "title": "Vacinar cachorro",
  "id_voluntario": 5,
  "status_tarefa": {
    "id_status": 2,
    "status": "assigned"
  },
  "voluntario": {
    "id_voluntario": 5,
    "nome": "João Silva",
    ...
  },
  ...
}
```

**Erros:**
- 404 Not Found: Tarefa ou voluntário não encontrado
- 400 Bad Request: Apenas tarefas pendentes podem ser atribuídas

#### PATCH /tasks/:id/complete
Marca uma tarefa como concluída.

**Validações:**
- Tarefa deve existir
- Tarefa deve estar com status "assigned"

**Response (200):**
```json
{
  "id_tarefa": 1,
  "title": "Vacinar cachorro",
  "id_voluntario": 5,
  "status_tarefa": {
    "id_status": 3,
    "status": "completed"
  },
  ...
}
```

**Erros:**
- 404 Not Found: Tarefa não encontrada
- 400 Bad Request: Apenas tarefas atribuídas podem ser concluídas

---

## Fluxo de Estados das Tarefas

```
pending → assigned → completed
```

1. **pending**: Tarefa criada mas ainda não atribuída
2. **assigned**: Tarefa atribuída a um voluntário
3. **completed**: Tarefa concluída

**Regras:**
- Apenas tarefas "pending" podem ser atribuídas
- Apenas tarefas "assigned" podem ser marcadas como concluídas

---

## Modelo de Dados

### Tabela: voluntario
- `id_voluntario` (PK)
- `nome` (VARCHAR 100)
- `cpf` (CHAR 11, UNIQUE)
- `email` (VARCHAR 100, UNIQUE)
- `telefone` (VARCHAR 15)
- `habilidades` (VARCHAR 200, CSV)
- `preferencias_atuacao` (VARCHAR 200)

### Tabela: preferencia
- `id_preferencia` (PK)
- `id_voluntario` (FK → voluntario)
- `tipo` (VARCHAR 50)
- `valor` (VARCHAR 200)
- `created_at` (TIMESTAMP)

### Tabela: tarefa
- `id_tarefa` (PK)
- `title` (VARCHAR 100)
- `descricao` (VARCHAR 200)
- `data` (DATE)
- `due_date` (DATE, nullable)
- `target_entity` (VARCHAR 50, nullable)
- `id_status` (FK → status_tarefa)
- `id_voluntario` (FK → voluntario, nullable)
- `id_animal` (FK → animal, nullable)
- `created_at` (TIMESTAMP)
- `updated_at` (TIMESTAMP)

### Tabela: status_tarefa
- `id_status` (PK)
- `status` (VARCHAR 20, UNIQUE)

**Valores padrão:** pending, assigned, completed

---

## Notas de Implementação

### Habilidades
As habilidades dos voluntários são armazenadas como CSV (valores separados por vírgula) no campo `habilidades` para compatibilidade com o schema existente. Em versões futuras, pode-se migrar para uma tabela many-to-many dedicada.

### Status de Tarefas
Os status (pending, assigned, completed) são criados automaticamente durante a execução da API usando `upsert`. Para ambientes de produção, é recomendado inserir esses valores manualmente no banco antes do deploy.

### Triggers
A migração cria um trigger para atualizar automaticamente o campo `updated_at` da tabela `tarefa` sempre que uma linha é modificada.

### Validações
Todas as validações são feitas tanto no nível de DTO (class-validator) quanto no nível de serviço para garantir integridade dos dados.
